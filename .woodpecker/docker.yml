depends_on:
  - test
  - web

variables:
  - &golang_image 'golang:1.20.2'
  - &node_image 'node:18-alpine'
  - &xgo_image 'techknowlogick/xgo:go-1.20.2'
  - &xgo_version 'go-1.20.2'
  - &platforms_release 'linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/386,linux/amd64,linux/ppc64le,linux/riscv64,linux/s390x,windows/amd64,freebsd/arm64,freebsd/amd64,openbsd/arm64,openbsd/amd64'
  - &platforms_server 'linux/arm/v7,linux/arm64/v8,linux/amd64,linux/ppc64le,linux/riscv64'
  - &platforms_preview 'linux/arm/v6,linux/arm64/v8,linux/amd64,linux/riscv64,windows/amd64'
  - &platforms_alpine 'linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/amd64,linux/ppc64le'

pipeline: &legacy
  vendor:
    image: *golang_image
    pull: true
    commands:
      - go mod vendor

  ###############
  # S e r v e r #
  ###############
  build-web:
    image: *node_image
    directory: web/
    commands:
      - corepack enable
      - pnpm install --frozen-lockfile
      - pnpm build

  cross-compile-server:
    image: *xgo_image
    pull: true
    commands:
      - apt update
      - apt install -y tree
      - make cross-compile-server
    environment:
      PLATFORMS: linux|arm/v7;linux|arm64/v8;linux|amd64;linux|ppc64le;linux|riscv64
      TAGS: bindata sqlite sqlite_unlock_notify netgo
      XGO_VERSION: *xgo_version

  publish-server-preview:
    image: woodpeckerci/plugin-docker-buildx
    secrets: [ docker_username, docker_password ]
    group: docker
    settings:
      repo: woodpeckerci/woodpecker-server
      dockerfile: docker/Dockerfile.server.multiarch
      platforms: *platforms_server
      tag: pull_${CI_COMMIT_PULL_REQUEST}
    when:
      event: pull_request

  publish-server-alpine-preview:
    image: woodpeckerci/plugin-docker-buildx
    secrets: [ docker_username, docker_password ]
    group: docker
    settings:
      repo: woodpeckerci/woodpecker-server
      dockerfile: docker/Dockerfile.server.alpine.multiarch
      platforms: *platforms_alpine
      tag: pull_${CI_COMMIT_PULL_REQUEST}-alpine
    when:
      event: pull_request

steps: *legacy
