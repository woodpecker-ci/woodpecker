clone:
  git:
    image: plugins/git:next

branches: master

pipeline:
  fetch:
    image: docker:git
    commands:
      - git fetch --tags
      - git status
    when:
      event: push
      branch: master

  prepare-release:
    image: node:14-alpine
    secrets: [github_token]
    commands:
      - apk add git
      - npm i semantic-release @semantic-release/exec
      - npx semantic-release --dry-run
    when:
      event: push
      branch: master

  prepare-build:
    image: golang:1.16
    commands:
      - export WOODPECKER_VERSION=$(cat ./woodpecker-version)
      - echo "Version $WOODPECKER_VERSION"
      - test "v-$WOODPECKER_VERSION" != "v-" || exit 0
      - go mod tidy
      - go get github.com/woodpecker-ci/togo
      - cd web/
      - go generate ./...
    when:
      event: push
      branch: master

  build:
    image: ghcr.io/goreleaser/goreleaser:v0.174.1
    commands:
      - export WOODPECKER_VERSION=$(cat ./woodpecker-version)
      - test "v-$WOODPECKER_VERSION" != "v-" || exit 0
      - export GORELEASER_CURRENT_TAG="$WOODPECKER_VERSION"
      - goreleaser release --skip-validate --rm-dist --skip-publish
    when:
      event: push
      branch: master

  build-docker-server:
    group: build-docker
    image: anbraten/kaniko:v1.6.0-debug
    secrets: [docker_username, docker_password]
    environment:
      - IMAGE_TYPE=server
    commands:
      - export WOODPECKER_VERSION=$(cat ./woodpecker-version)
      - test "v-$WOODPECKER_VERSION" != "v-" || exit 0
      - .woodpecker/scripts/build-docker-image.sh
    when:
      event: push
      branch: master

  build-docker-agent:
    group: build-docker
    image: anbraten/kaniko:v1.6.0-debug
    secrets: [docker_username, docker_password]
    environment:
      - IMAGE_TYPE=agent
    commands:
      - export WOODPECKER_VERSION=$(cat ./woodpecker-version)
      - test "v-$WOODPECKER_VERSION" != "v-" || exit 0
      - .woodpecker/scripts/build-docker-image.sh
    when:
      event: push
      branch: master

  build-docker-cli:
    group: build-docker
    image: anbraten/kaniko:v1.6.0-debug
    secrets: [docker_username, docker_password]
    environment:
      - IMAGE_TYPE=cli
    commands:
      - export WOODPECKER_VERSION=$(cat ./woodpecker-version)
      - test "v-$WOODPECKER_VERSION" != "v-" || exit 0
      - .woodpecker/scripts/build-docker-image.sh
    when:
      event: push
      branch: master

  release:
    image: node:14-alpine
    secrets: [github_token]
    commands:
      - export WOODPECKER_VERSION=$(cat ./woodpecker-version)
      - echo "Version $WOODPECKER_VERSION"
      - apk add git
      # should already be installed by prepare-release
      - npm i semantic-release @semantic-release/exec
      - npx semantic-release
    when:
      event: push
      branch: master

# TODO
# depends_on:
#   - "woodpecker/.test"
