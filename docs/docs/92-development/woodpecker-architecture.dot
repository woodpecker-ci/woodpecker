digraph woodpecker {
    rankdir=TB;
    bgcolor="#1a1a1a";
    pad=0.4;
    nodesep=0.5;
    ranksep=1.4;
    splines=ortho;
    concentrate=true;

    node [
        shape=box,
        style="filled,rounded",
        fontname="Arial",
        fontsize=11,
        margin=0.18,
        penwidth=1.6
    ];

    edge [
        color="#6b6b6b",
        penwidth=1.4,
        arrowsize=0.75
    ];

    // =========================================================
    // LANES (visual columns)
    // =========================================================
    lane_pipelines [style=invis,width=0];
    lane_agent     [style=invis,width=0];
    lane_cli       [style=invis,width=0];
    lane_server    [style=invis,width=0];
    lane_external  [style=invis,width=0];

    lane_pipelines -> lane_agent -> lane_cli -> lane_server -> lane_external [style=invis];

    // =========================================================
    // PIPELINES
    // =========================================================
    subgraph cluster_pipelines {
        label="Pipelines";
        style=filled;
        color="#2a2a2a";
        fillcolor="#f5deb3";
        fontsize=14;

        { rank=same; lane_pipelines; pipeline; }

        pipeline [label="pipeline/", fillcolor="#5a6c7d", fontcolor="#ffffff"];
        pipeline_backend [
            label="pipeline/backend/\n(docker, k8s, local)",
            fillcolor="#5a6c7d", fontcolor="#ffffff"
        ];
        pipeline_frontend [
            label="pipeline/frontend/\n(yaml parsing)",
            fillcolor="#5a6c7d", fontcolor="#ffffff"
        ];

        pipeline -> pipeline_backend;
        pipeline -> pipeline_frontend;
    }

    // =========================================================
    // AGENT
    // =========================================================
    subgraph cluster_agent {
        label="Agent";
        style=filled;
        color="#2a2a2a";
        fillcolor="#f5deb3";
        fontsize=14;

        { rank=min; cmd_agent; }
        { rank=same; lane_agent; agent; }

        cmd_agent [label="cmd/agent/", fillcolor="#c85a6e", fontcolor="#ffffff"];
        agent     [label="agent/",     fillcolor="#5a6c7d", fontcolor="#ffffff"];

        cmd_agent -> agent [weight=5];
    }

    // =========================================================
    // CLI
    // =========================================================
    subgraph cluster_cli {
        label="CLI";
        style=filled;
        color="#2a2a2a";
        fillcolor="#a8dcd9";
        fontsize=14;

        { rank=min; cmd_cli; }
        { rank=same; lane_cli; cli; woodpecker_go; }

        cmd_cli [label="cmd/cli/", fillcolor="#c85a6e", fontcolor="#ffffff"];
        cli     [label="cli/",     fillcolor="#5a6c7d", fontcolor="#ffffff"];
        woodpecker_go [label="woodpecker-go/", fillcolor="#5a6c7d", fontcolor="#ffffff"];

        cmd_cli -> cli [weight=5];
        cli -> woodpecker_go;
    }

    // =========================================================
    // SERVER
    // =========================================================
    subgraph cluster_server {
        label="Server";
        style=filled;
        color="#2a2a2a";
        fillcolor="#d4d4f7";
        fontsize=14;

        // Entry
        { rank=min; cmd_server; }

        cmd_server [label="cmd/server/", fillcolor="#c85a6e", fontcolor="#ffffff"];

        // ---- API BAND
        { rank=same;
          lane_server;
          server_router;
          server_web;
          server_api;
          server_rpc;
        }

        server_router [label="server/router/", fillcolor="#3a3a3a", fontcolor="#ffffff"];
        server_web    [label="server/web/",    fillcolor="#3a3a3a", fontcolor="#ffffff"];
        server_api    [label="server/api/",    fillcolor="#3a3a3a", fontcolor="#ffffff"];
        server_rpc    [label="server/rpc/",    fillcolor="#5a6c7d", fontcolor="#ffffff"];

        // ---- CORE SERVICES
        { rank=same;
          server_pipeline;
          server_queue;
          server_pubsub;
          server_logging;
        }

        server_pipeline [label="server/pipeline/", fillcolor="#5a6c7d", fontcolor="#ffffff"];
        server_queue    [label="server/queue/",    fillcolor="#5a6c7d", fontcolor="#ffffff"];
        server_pubsub   [label="server/pubsub/",   fillcolor="#5a6c7d", fontcolor="#ffffff"];
        server_logging  [label="server/logging/",  fillcolor="#5a6c7d", fontcolor="#ffffff"];

        // ---- SUPPORTING
        { rank=same;
          server_cache;
          server_cron;
          server_badges;
          server_ccmenu;
        }

        server_cache   [label="server/cache/",   fillcolor="#5a6c7d", fontcolor="#ffffff"];
        server_cron    [label="server/cron/",    fillcolor="#5a6c7d", fontcolor="#ffffff"];
        server_badges  [label="server/badges/",  fillcolor="#5a6c7d", fontcolor="#ffffff"];
        server_ccmenu  [label="server/ccmenu/",  fillcolor="#5a6c7d", fontcolor="#ffffff"];

        // ---- DATA + REMOTE
        { rank=same;
          server_forge;
          server_store;
          server_model;
        }

        server_forge [
            label="server/forge/\n[github, gitlab, gitea,\nforgejo, bitbucket,\nbitbucket-dc, addon]",
            fillcolor="#5a6c7d", fontcolor="#ffffff"
        ];
        server_store [label="server/store/", fillcolor="#3a3a3a", fontcolor="#ffffff"];
        server_model [label="server/model/", fillcolor="#5a6c7d", fontcolor="#ffffff"];

        // ---- EXTENSIONS
        server_services [
            label="server/services/\n[config, secrets, registry,\nenvironment, encryption,\nlog, permissions]",
            fillcolor="#5a6c7d", fontcolor="#ffffff"
        ];

        // Entry wiring
        cmd_server -> server_router [weight=6];
        cmd_server -> server_web    [weight=6];
        cmd_server -> server_rpc    [weight=6];
        cmd_server -> server_services;

        // API flow
        server_router -> server_api;
        server_router -> server_web;

        server_api -> server_pipeline;
        server_api -> server_queue;
        server_api -> server_pubsub;
        server_api -> server_model;

        // Core flow
        server_pipeline -> server_queue;
        server_pipeline -> server_pubsub;
        server_pipeline -> server_forge;

        // Extensions
        server_services -> server_store;
        server_services -> server_forge;
    }

    // =========================================================
    // SHARED LIBS
    // =========================================================
    subgraph cluster_shared {
        label="Shared Libs";
        style=filled;
        color="#2a2a2a";
        fillcolor="#e0e0e0";
        fontsize=14;

        { rank=same; shared_httputil; shared_logger; shared_constant; }
        { rank=same; shared_token; shared_utils; shared_optional; }

        shared_httputil  [label="shared/httputil/",  fillcolor="#5a6c7d", fontcolor="#ffffff"];
        shared_logger    [label="shared/logger/",    fillcolor="#5a6c7d", fontcolor="#ffffff"];
        shared_constant  [label="shared/constant/",  fillcolor="#5a6c7d", fontcolor="#ffffff"];
        shared_token     [label="shared/token/",     fillcolor="#5a6c7d", fontcolor="#ffffff"];
        shared_utils     [label="shared/utils/",     fillcolor="#5a6c7d", fontcolor="#ffffff"];
        shared_optional  [label="shared/optional/",  fillcolor="#5a6c7d", fontcolor="#ffffff"];
    }

    // =========================================================
    // EXTERNAL
    // =========================================================
    scm [
        label="SCM Providers",
        shape=ellipse,
        fillcolor="#e8e8e8",
        fontcolor="#000000"
    ];

    database [
        label="Database",
        shape=cylinder,
        fillcolor="#e8e8e8",
        fontcolor="#000000"
    ];

    { rank=same; lane_external; scm; database; }

    server_forge -> scm      [style=dashed, minlen=3];
    server_store -> database [style=dashed, minlen=3];

    // =========================================================
    // CROSS-COMPONENT CONNECTIONS
    // =========================================================
    cli -> pipeline;
    agent -> pipeline;

    server_rpc -> agent [style=dashed, color="#9370db"];
    server_web -> web   [style=dashed, color="#2e8b57"];

    // VERSION
    version [label="version/", fillcolor="#c0c0c0"];
    cmd_server -> version;
    cmd_agent  -> version;
    cmd_cli    -> version;
}
